<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#3b82f6">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="icon.svg">
<title>Lernkarten Intensivpflege</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: #f0f4f8;
  color: #1e293b;
  min-height: 100vh;
  min-height: 100dvh;
}

/* ── Password Screen ── */
#loginScreen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  min-height: 100dvh;
  padding: 20px;
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
}

.login-box {
  background: #fff;
  padding: 40px 32px;
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  text-align: center;
  max-width: 360px;
  width: 100%;
}

.login-box h1 { font-size: 1.5rem; margin-bottom: 8px; }
.login-box p { color: #64748b; font-size: 0.9rem; margin-bottom: 24px; }

.login-input {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-size: 1rem;
  text-align: center;
  margin-bottom: 16px;
  outline: none;
  transition: border-color 0.2s;
}
.login-input:focus { border-color: #3b82f6; }
.login-input.error { border-color: #ef4444; animation: shake 0.4s; }

@keyframes shake {
  0%,100% { transform: translateX(0); }
  25% { transform: translateX(-8px); }
  75% { transform: translateX(8px); }
}

.login-btn {
  width: 100%;
  padding: 14px;
  background: #3b82f6;
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
}
.login-btn:hover { background: #2563eb; }

/* ── Loading ── */
#loadingScreen {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  min-height: 100dvh;
  color: #64748b;
  font-size: 1rem;
}

/* ── App ── */
#app { display: none; }

header {
  background: #fff;
  padding: 12px 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 8px;
  position: sticky;
  top: 0;
  z-index: 50;
}

header h1 { font-size: 1.1rem; }

.controls { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }

select, .btn {
  padding: 7px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 0.85rem;
  background: #fff;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s;
}

.btn { border: none; }
.btn-sm { padding: 6px 10px; font-size: 0.8rem; }
.btn-secondary { background: #e2e8f0; color: #475569; }
.btn-secondary:hover { background: #cbd5e1; }
.btn-secondary.active { background: #3b82f6; color: #fff; }
.btn-primary { background: #3b82f6; color: #fff; }
.btn-primary:hover { background: #2563eb; }
.btn-success { background: #22c55e; color: #fff; }
.btn-success:hover { background: #16a34a; }
.btn-danger { background: #ef4444; color: #fff; }
.btn-danger:hover { background: #dc2626; }

/* ── Stats Bar ── */
.stats-bar {
  max-width: 700px;
  margin: 12px auto 0;
  padding: 0 16px;
}

.box-stats {
  display: flex;
  gap: 4px;
  margin-bottom: 8px;
}

.box-stat {
  flex: 1;
  text-align: center;
  padding: 8px 4px;
  border-radius: 8px;
  font-size: 0.7rem;
  font-weight: 600;
  line-height: 1.3;
}

.box-stat .count { font-size: 1.1rem; display: block; }
.box-stat-new { background: #f1f5f9; color: #64748b; }
.box-stat-1 { background: #fee2e2; color: #dc2626; }
.box-stat-2 { background: #ffedd5; color: #ea580c; }
.box-stat-3 { background: #fef9c3; color: #ca8a04; }
.box-stat-4 { background: #dcfce7; color: #16a34a; }
.box-stat-5 { background: #dbeafe; color: #2563eb; }

.due-info {
  text-align: center;
  font-size: 0.85rem;
  color: #64748b;
  padding: 4px 0;
}

.due-info strong { color: #3b82f6; }

/* ── Progress ── */
.progress-container {
  max-width: 700px;
  margin: 8px auto 0;
  padding: 0 16px;
}

.progress-bar {
  height: 5px;
  background: #e2e8f0;
  border-radius: 3px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #8b5cf6);
  border-radius: 3px;
  transition: width 0.3s;
}

.progress-text {
  font-size: 0.8rem;
  color: #94a3b8;
  text-align: center;
  margin-top: 4px;
}

/* ── Card ── */
.card-container {
  max-width: 700px;
  margin: 12px auto;
  padding: 0 16px;
  perspective: 1000px;
}

.card {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.08);
  overflow: hidden;
}

.card-header {
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  border-bottom: 1px solid #f1f5f9;
}

.badge {
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 0.7rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.badge-mc { background: #dbeafe; color: #1d4ed8; }
.badge-offen { background: #ede9fe; color: #6d28d9; }
.badge-deck { background: #fef3c7; color: #92400e; }

.badge-box {
  margin-left: auto;
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 0.7rem;
  font-weight: 600;
}
.badge-box-new { background: #f1f5f9; color: #64748b; }
.badge-box-1 { background: #fee2e2; color: #dc2626; }
.badge-box-2 { background: #ffedd5; color: #ea580c; }
.badge-box-3 { background: #fef9c3; color: #ca8a04; }
.badge-box-4 { background: #dcfce7; color: #16a34a; }
.badge-box-5 { background: #dbeafe; color: #2563eb; }

.card-id { font-size: 0.8rem; color: #94a3b8; font-weight: 600; }

.card-body { padding: 20px 16px; }

.question-text {
  font-size: 1.05rem;
  line-height: 1.6;
  white-space: pre-line;
  margin-bottom: 16px;
}

/* ── MC Options ── */
.options-list { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }

.option {
  padding: 12px 14px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 0.9rem;
  line-height: 1.5;
  display: flex;
  align-items: flex-start;
  gap: 10px;
}
.option:hover { border-color: #93c5fd; background: #eff6ff; }
.option.selected { border-color: #3b82f6; background: #dbeafe; }
.option.correct { border-color: #22c55e; background: #dcfce7; }
.option.wrong { border-color: #ef4444; background: #fee2e2; }

.option-marker {
  width: 22px; height: 22px;
  border-radius: 50%;
  border: 2px solid #cbd5e1;
  flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.7rem; font-weight: 700;
  margin-top: 1px;
  transition: all 0.2s;
}
.option.selected .option-marker { border-color: #3b82f6; background: #3b82f6; color: #fff; }
.option.correct .option-marker { border-color: #22c55e; background: #22c55e; color: #fff; }
.option.wrong .option-marker { border-color: #ef4444; background: #ef4444; color: #fff; }

.action-area { text-align: center; margin-top: 16px; }

.explanation {
  background: #f0fdf4;
  border-left: 4px solid #22c55e;
  padding: 14px;
  border-radius: 0 8px 8px 0;
  margin-top: 16px;
  font-size: 0.9rem;
  line-height: 1.6;
  display: none;
}
.explanation.visible { display: block; }

.source {
  margin-top: 12px;
  padding: 10px 14px;
  background: #f8fafc;
  border-radius: 8px;
  font-size: 0.75rem;
  color: #64748b;
  display: none;
}
.source.visible { display: block; }

/* ── Leitner Rating ── */
.leitner-buttons {
  display: none;
  gap: 12px;
  justify-content: center;
  margin-top: 16px;
}
.leitner-buttons.visible { display: flex; }
.leitner-btn {
  padding: 12px 28px;
  border: none;
  border-radius: 12px;
  font-size: 0.95rem;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.1s;
}
.leitner-btn:active { transform: scale(0.95); }

/* ── Flip Card ── */
.flip-card .card-inner {
  position: relative;
  transition: transform 0.6s;
  transform-style: preserve-3d;
}
.flip-card .card-inner.flipped { transform: rotateY(180deg); }
.flip-card .card-front, .flip-card .card-back {
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}
.flip-card .card-back {
  position: absolute;
  top: 0; left: 0; width: 100%;
  transform: rotateY(180deg);
}

.flip-hint {
  text-align: center;
  color: #94a3b8;
  font-size: 0.85rem;
  margin-top: 20px;
  user-select: none;
}

.answer-list { list-style: none; padding: 0; }
.answer-list li {
  padding: 6px 0;
  border-bottom: 1px solid #f1f5f9;
  font-size: 0.9rem;
  line-height: 1.5;
}
.answer-list li:last-child { border-bottom: none; }
.answer-list li.indent { padding-left: 20px; font-size: 0.85rem; color: #475569; }

/* ── Session Complete ── */
.session-complete {
  text-align: center;
  padding: 48px 20px;
}
.session-complete h2 { font-size: 1.5rem; margin-bottom: 12px; color: #22c55e; }
.session-complete p { color: #64748b; margin-bottom: 8px; }
.session-complete .btn { margin-top: 20px; padding: 14px 32px; font-size: 1rem; }

/* ── Navigation ── */
.nav-bar {
  max-width: 700px;
  margin: 8px auto;
  padding: 0 16px;
  display: flex;
  justify-content: center;
  gap: 10px;
}
.nav-bar .btn {
  min-width: 110px;
  text-align: center;
  font-size: 0.95rem;
  padding: 11px 20px;
}

.keyboard-hint {
  text-align: center;
  color: #94a3b8;
  font-size: 0.7rem;
  margin-top: 12px;
  max-width: 700px;
  margin-left: auto;
  margin-right: auto;
}

/* ── Settings Overlay ── */
.settings-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4);
  z-index: 200;
  justify-content: center;
  align-items: flex-start;
  padding: 60px 16px 16px;
}
.settings-overlay.open { display: flex; }

.settings-panel {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  max-width: 420px;
  width: 100%;
  max-height: calc(100vh - 80px);
  max-height: calc(100dvh - 80px);
  overflow-y: auto;
}

.settings-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid #f1f5f9;
}
.settings-header h2 { font-size: 1.1rem; }
.settings-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #94a3b8;
  padding: 4px 8px;
  line-height: 1;
}

.settings-body { padding: 8px 0; }

.settings-section {
  padding: 16px 20px;
  border-bottom: 1px solid #f1f5f9;
}
.settings-section:last-child { border-bottom: none; }
.settings-section h3 { font-size: 0.9rem; margin-bottom: 6px; }

.settings-hint {
  font-size: 0.8rem;
  color: #64748b;
  margin-bottom: 12px;
  line-height: 1.4;
}

.settings-buttons { display: flex; gap: 8px; }
.settings-buttons .btn { flex: 1; }

.settings-danger {
  background: #fef2f2;
  border-radius: 0 0 16px 16px;
}
.settings-danger h3 { color: #dc2626; }

@media (max-width: 600px) {
  header h1 { font-size: 0.95rem; }
  .card-body { padding: 16px 14px; }
  .question-text { font-size: 0.95rem; }
  .keyboard-hint { display: none; }
  .box-stat { padding: 6px 2px; font-size: 0.65rem; }
  .box-stat .count { font-size: 0.95rem; }
}
</style>
</head>
<body>

<!-- Password Screen -->
<div id="loginScreen">
  <div class="login-box">
    <h1>Lernkarten</h1>
    <p>Intensivpflege Klausurvorbereitung</p>
    <input type="password" id="passwordInput" class="login-input" placeholder="Passwort" autofocus>
    <button class="login-btn" onclick="checkPassword()">Anmelden</button>
  </div>
</div>

<!-- Loading Screen -->
<div id="loadingScreen">
  <p>Karten werden geladen...</p>
</div>

<!-- App -->
<div id="app">
  <header>
    <h1>Lernkarten</h1>
    <div class="controls">
      <select id="deckSelect" onchange="applyDeck(this.value)"></select>
      <select id="modeSelect" onchange="setMode(this.value)">
        <option value="learn">Lernen</option>
        <option value="random">Zufall</option>
        <option value="browse">Durchblaettern</option>
      </select>
      <select id="filterSelect" onchange="applyFilter(this.value)"></select>
      <button class="btn btn-sm btn-secondary" onclick="shuffleCards()" title="Mischen">&#x1F500;</button>
      <button class="btn btn-sm btn-secondary" onclick="toggleSettings()" title="Einstellungen">&#x2699;</button>
    </div>
  </header>

  <!-- Settings Overlay -->
  <div class="settings-overlay" id="settingsOverlay" onclick="closeSettingsOutside(event)">
    <div class="settings-panel">
      <div class="settings-header">
        <h2>Einstellungen</h2>
        <button class="settings-close" onclick="toggleSettings()">&times;</button>
      </div>
      <div class="settings-body">
        <div class="settings-section">
          <h3>Fortschritt sichern</h3>
          <p class="settings-hint">Lade deinen Lernfortschritt als Datei herunter oder importiere eine gespeicherte Datei.</p>
          <div class="settings-buttons">
            <button class="btn btn-primary" onclick="exportProgress()">&#x2B07; Herunterladen</button>
            <button class="btn btn-secondary" onclick="importProgress()">&#x2B06; Datei laden</button>
          </div>
        </div>
        <div class="settings-section">
          <h3>Lerneinstellungen</h3>
          <p class="settings-hint">Wie viele neue Karten pro Tag dazukommen sollen. Wiederholungen sind unbegrenzt.</p>
          <div class="settings-buttons" id="newCardsButtons">
            <button class="btn btn-secondary" onclick="setNewCardsPerDay(5)">5</button>
            <button class="btn btn-secondary" onclick="setNewCardsPerDay(10)">10</button>
            <button class="btn btn-secondary" onclick="setNewCardsPerDay(15)">15</button>
            <button class="btn btn-secondary" onclick="setNewCardsPerDay(20)">20</button>
          </div>
        </div>
        <div class="settings-section">
          <h3>Abmelden</h3>
          <button class="btn btn-secondary" onclick="logout()">Abmelden</button>
        </div>
        <div class="settings-section settings-danger">
          <h3>Gefahrenzone</h3>
          <p class="settings-hint">Setzt den gesamten Lernfortschritt unwiderruflich zurueck. Alle Boxen werden geleert.</p>
          <button class="btn btn-danger" onclick="resetProgress()">Fortschritt zuruecksetzen</button>
        </div>
      </div>
    </div>
  </div>

  <div class="stats-bar">
    <div class="box-stats" id="boxStats"></div>
    <div class="due-info" id="dueInfo"></div>
  </div>

  <div class="progress-container">
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <div class="progress-text" id="progressText"></div>
  </div>

  <div class="nav-bar">
    <button class="btn btn-secondary" onclick="navigate(-1)">&larr; Zurueck</button>
    <button class="btn btn-primary" onclick="navigate(1)">Weiter &rarr;</button>
  </div>

  <div class="card-container" id="cardContainer"></div>

  <div class="keyboard-hint">&#8592; &#8594; Navigieren &middot; Leertaste Umdrehen/Pruefen</div>
</div>

<script>
// ── Data (loaded from cards.json) ──
let ALL_CARDS = [];
let ALL_DECKS = [];
const PASSWORD_HASH = '2c9e0a2585dc7406589a3724f0027811506e0f133726303a15d6779d532a2573';

// ── Leitner Config ──
const BOXES = {
  0: { name: 'Neu', interval: 0 },
  1: { name: 'Box 1', interval: 1 },
  2: { name: 'Box 2', interval: 3 },
  3: { name: 'Box 3', interval: 7 },
  4: { name: 'Box 4', interval: 14 },
  5: { name: 'Box 5', interval: 30 }
};

// ── State ──
let cards = [];
let currentIndex = 0;
let mcChecked = false;
let selectedOptions = new Set();
let isFlipped = false;
let mode = 'learn';
let filter = 'all';
let deck = 'all';
let leitnerData = {};
let sessionStats = { correct: 0, wrong: 0 };

// ── Password ──
async function sha256(text) {
  const data = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function checkPassword() {
  const input = document.getElementById('passwordInput');
  const hash = await sha256(input.value);
  if (hash === PASSWORD_HASH) {
    localStorage.setItem('lk_auth', 'yes');
    loadAndStart();
  } else {
    input.classList.add('error');
    input.value = '';
    setTimeout(() => input.classList.remove('error'), 400);
  }
}

document.getElementById('passwordInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') checkPassword();
});

// ── Load Cards ──
async function loadCards() {
  const resp = await fetch('./cards.json');
  const data = await resp.json();
  ALL_DECKS = data.decks;
  ALL_CARDS = data.cards;
}

async function loadAndStart() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('loadingScreen').style.display = 'flex';
  await loadCards();
  document.getElementById('loadingScreen').style.display = 'none';
  showApp();
}

function showApp() {
  document.getElementById('app').style.display = 'block';
  loadLeitnerData();
  buildDeckSelect();
  buildFilterSelect();
  highlightNewCardsButton();
  setMode('learn');
}

// ── Deck & Filter Selects ──
function buildDeckSelect() {
  const sel = document.getElementById('deckSelect');
  sel.innerHTML = '';
  if (ALL_DECKS.length > 1) {
    sel.innerHTML += '<option value="all">Alle Decks</option>';
  }
  ALL_DECKS.forEach(d => {
    sel.innerHTML += '<option value="' + d.id + '">' + d.name + '</option>';
  });
  // Hide dropdown if only one deck
  if (ALL_DECKS.length <= 1) {
    sel.style.display = 'none';
    deck = ALL_DECKS.length === 1 ? String(ALL_DECKS[0].id) : 'all';
  }
}

function buildFilterSelect() {
  const pool = getPoolForDeck();
  const mc = pool.filter(c => c.type === 'mc').length;
  const offen = pool.filter(c => c.type === 'offen').length;
  const total = pool.length;
  const sel = document.getElementById('filterSelect');
  sel.innerHTML =
    '<option value="all">Alle (' + total + ')</option>' +
    '<option value="mc">MC (' + mc + ')</option>' +
    '<option value="offen">Offen (' + offen + ')</option>';
  sel.value = filter;
}

function getPoolForDeck() {
  if (deck === 'all') return ALL_CARDS;
  return ALL_CARDS.filter(c => c.deck_id === parseInt(deck));
}

function applyDeck(d) {
  deck = d;
  filter = 'all';
  buildFilterSelect();
  buildCardList();
  renderCard();
}

// ── Leitner Storage ──
function cardKey(card) {
  return 'card-' + card.id;
}

function loadLeitnerData() {
  try {
    const saved = localStorage.getItem('lk_leitner');
    leitnerData = saved ? JSON.parse(saved) : {};
  } catch { leitnerData = {}; }
}

function saveLeitnerData() {
  localStorage.setItem('lk_leitner', JSON.stringify(leitnerData));
}

function getCardData(card) {
  const key = cardKey(card);
  if (!leitnerData[key]) {
    leitnerData[key] = { box: 0, nextReview: todayStr() };
  }
  return leitnerData[key];
}

function todayStr() {
  return new Date().toISOString().split('T')[0];
}

function addDays(dateStr, days) {
  const d = new Date(dateStr + 'T00:00:00');
  d.setDate(d.getDate() + days);
  return d.toISOString().split('T')[0];
}

function isDue(card) {
  const data = getCardData(card);
  return data.nextReview <= todayStr();
}

function markCorrect(card) {
  const data = getCardData(card);
  if (data.box === 0) trackNewCardIntroduced();
  data.box = Math.min(data.box + 1, 5);
  data.nextReview = addDays(todayStr(), BOXES[data.box].interval);
  saveLeitnerData();
  sessionStats.correct++;
}

function markWrong(card) {
  const data = getCardData(card);
  if (data.box === 0) trackNewCardIntroduced();
  data.box = 1;
  data.nextReview = todayStr();
  saveLeitnerData();
  sessionStats.wrong++;
}

// ── Daily Limit ──
const DEFAULT_NEW_PER_DAY = 15;

function getSettings() {
  try {
    return JSON.parse(localStorage.getItem('lk_settings')) || {};
  } catch { return {}; }
}

function saveSettings(s) {
  localStorage.setItem('lk_settings', JSON.stringify(s));
}

function getNewCardsPerDay() {
  return getSettings().newCardsPerDay || DEFAULT_NEW_PER_DAY;
}

function getDailyTracker() {
  try {
    const d = JSON.parse(localStorage.getItem('lk_daily')) || {};
    if (d.date !== todayStr()) return { date: todayStr(), newIntroduced: 0 };
    return d;
  } catch { return { date: todayStr(), newIntroduced: 0 }; }
}

function saveDailyTracker(t) {
  localStorage.setItem('lk_daily', JSON.stringify(t));
}

function trackNewCardIntroduced() {
  const t = getDailyTracker();
  t.newIntroduced++;
  saveDailyTracker(t);
}

function setNewCardsPerDay(n) {
  const s = getSettings();
  s.newCardsPerDay = n;
  saveSettings(s);
  highlightNewCardsButton();
  buildCardList();
  renderCard();
}

function highlightNewCardsButton() {
  const current = getNewCardsPerDay();
  document.querySelectorAll('#newCardsButtons .btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.textContent) === current);
  });
}

// ── Modes & Filtering ──
function setMode(m) {
  mode = m;
  document.getElementById('modeSelect').value = m;
  buildCardList();
  renderCard();
}

function applyFilter(f) {
  filter = f;
  buildCardList();
  renderCard();
}

function buildCardList() {
  let pool = getPoolForDeck();

  // Type filter
  if (filter === 'mc') pool = pool.filter(c => c.type === 'mc');
  else if (filter === 'offen') pool = pool.filter(c => c.type === 'offen');

  if (mode === 'learn') {
    // Wiederholungen: Box >= 1 und faellig
    const reviews = pool.filter(c => {
      const d = getCardData(c);
      return d.box >= 1 && isDue(c);
    });

    // Neue Karten: Box 0, begrenzt auf Tageslimit
    const limit = getNewCardsPerDay();
    const tracker = getDailyTracker();
    const remaining = Math.max(0, limit - tracker.newIntroduced);
    const newCards = pool.filter(c => getCardData(c).box === 0).slice(0, remaining);

    // Wiederholungen zuerst, dann neue
    pool = [...reviews, ...newCards];
    pool.sort((a, b) => getCardData(a).box - getCardData(b).box);
  } else if (mode === 'random') {
    // Alle Karten, zufaellig gemischt
    for (let i = pool.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [pool[i], pool[j]] = [pool[j], pool[i]];
    }
  }

  cards = pool;
  currentIndex = 0;
  sessionStats = { correct: 0, wrong: 0 };
  updateStats();
}

function shuffleCards() {
  for (let i = cards.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [cards[i], cards[j]] = [cards[j], cards[i]];
  }
  currentIndex = 0;
  renderCard();
}

// ── Settings ──
function toggleSettings() {
  document.getElementById('settingsOverlay').classList.toggle('open');
}

function closeSettingsOutside(event) {
  if (event.target === document.getElementById('settingsOverlay')) {
    toggleSettings();
  }
}

function exportProgress() {
  const json = JSON.stringify(leitnerData, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const now = new Date();
  const ts = now.getFullYear() + '-'
    + String(now.getMonth()+1).padStart(2,'0') + '-'
    + String(now.getDate()).padStart(2,'0') + '_'
    + String(now.getHours()).padStart(2,'0') + '-'
    + String(now.getMinutes()).padStart(2,'0');
  const a = document.createElement('a');
  a.href = url;
  a.download = 'lernkarten-fortschritt_' + ts + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importProgress() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        leitnerData = data;
        saveLeitnerData();
        buildCardList();
        renderCard();
        toggleSettings();
        alert('Fortschritt importiert!');
      } catch {
        alert('Ungueltige Datei. Bitte eine gueltige Fortschritt-Datei waehlen.');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function logout() {
  localStorage.removeItem('lk_auth');
  location.reload();
}

function resetProgress() {
  const input = prompt('Zum Bestaetigen "RESET" eingeben:');
  if (input !== 'RESET') return;
  leitnerData = {};
  saveLeitnerData();
  buildCardList();
  renderCard();
  toggleSettings();
  alert('Lernfortschritt zurueckgesetzt.');
}

// ── Stats ──
function updateStats() {
  const counts = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
  let dueCount = 0;
  const pool = getPoolForDeck();

  pool.forEach(card => {
    const data = getCardData(card);
    counts[data.box]++;
    if (isDue(card)) dueCount++;
  });

  document.getElementById('boxStats').innerHTML =
    '<div class="box-stat box-stat-new"><span class="count">' + counts[0] + '</span>Neu</div>' +
    '<div class="box-stat box-stat-1"><span class="count">' + counts[1] + '</span>Box 1</div>' +
    '<div class="box-stat box-stat-2"><span class="count">' + counts[2] + '</span>Box 2</div>' +
    '<div class="box-stat box-stat-3"><span class="count">' + counts[3] + '</span>Box 3</div>' +
    '<div class="box-stat box-stat-4"><span class="count">' + counts[4] + '</span>Box 4</div>' +
    '<div class="box-stat box-stat-5"><span class="count">' + counts[5] + '</span>Box 5</div>';

  const dueInfo = document.getElementById('dueInfo');
  if (mode === 'learn') {
    const reviewCount = cards.filter(c => getCardData(c).box >= 1).length;
    const newCount = cards.filter(c => getCardData(c).box === 0).length;
    const tracker = getDailyTracker();
    const limit = getNewCardsPerDay();
    dueInfo.innerHTML = '<strong>' + reviewCount + '</strong> Wiederholungen + <strong>' + newCount + '</strong> neue' +
      ' (Limit: ' + tracker.newIntroduced + '/' + limit + ')' +
      (sessionStats.correct + sessionStats.wrong > 0 ? ' &middot; ' + sessionStats.correct + ' richtig, ' + sessionStats.wrong + ' falsch' : '');
  } else if (mode === 'random') {
    dueInfo.innerHTML = '<strong>' + cards.length + '</strong> Karten' +
      (sessionStats.correct + sessionStats.wrong > 0 ? ' &middot; ' + sessionStats.correct + ' richtig, ' + sessionStats.wrong + ' falsch' : '');
  } else {
    dueInfo.innerHTML = '<strong>' + dueCount + '</strong> Karten faellig &middot; ' + pool.length + ' gesamt';
  }
}

// ── Navigation ──
function navigate(dir) {
  if (cards.length === 0) return;
  currentIndex = (currentIndex + dir + cards.length) % cards.length;
  renderCard();
}

function nextCard() {
  if (mode === 'learn') {
    const card = cards[currentIndex];
    if (card && !isDue(card)) {
      cards.splice(currentIndex, 1);
      if (cards.length === 0) { renderSessionComplete(); return; }
      if (currentIndex >= cards.length) currentIndex = 0;
    } else {
      currentIndex = (currentIndex + 1) % cards.length;
    }
  } else {
    if (currentIndex + 1 >= cards.length && mode === 'random') {
      renderSessionComplete();
      return;
    }
    currentIndex = (currentIndex + 1) % cards.length;
  }
  renderCard();
}

// ── Rendering ──
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function updateProgress() {
  if (cards.length === 0) return;
  const total = cards.length;
  const current = currentIndex + 1;
  document.getElementById('progressFill').style.width = (current / total * 100) + '%';
  document.getElementById('progressText').textContent = current + ' / ' + total;
}

function boxBadgeHtml(card) {
  const data = getCardData(card);
  const box = data.box;
  const name = box === 0 ? 'Neu' : 'Box ' + box;
  return '<span class="badge-box badge-box-' + box + '">' + name + '</span>';
}

function deckName(card) {
  const d = ALL_DECKS.find(dk => dk.id === card.deck_id);
  return d ? d.name : '';
}

function renderCard() {
  mcChecked = false;
  selectedOptions.clear();
  isFlipped = false;
  updateStats();

  if (cards.length === 0) {
    if (mode === 'learn' || mode === 'random') {
      renderSessionComplete();
    } else {
      document.getElementById('cardContainer').innerHTML =
        '<p style="text-align:center;color:#94a3b8;padding:40px;">Keine Karten in dieser Auswahl.</p>';
    }
    updateProgress();
    return;
  }

  const card = cards[currentIndex];
  updateProgress();

  if (card.type === 'mc') renderMC(card);
  else renderOffen(card);
}

function leitnerButtonsHtml() {
  return '<div class="leitner-buttons" id="leitnerBtns">' +
    '<button class="leitner-btn btn-danger" onclick="rateCard(false)">Nochmal &#10007;</button>' +
    '<button class="leitner-btn btn-success" onclick="rateCard(true)">Gewusst &#10003;</button>' +
    '</div>';
}

function rateCard(correct) {
  const card = cards[currentIndex];
  if (!card) return;
  if (correct) markCorrect(card);
  else markWrong(card);
  nextCard();
}

function renderMC(card) {
  const container = document.getElementById('cardContainer');
  let optionsHtml = '';
  card.options.forEach((opt, i) => {
    const letter = String.fromCharCode(65 + i);
    optionsHtml += '<div class="option" data-index="' + i + '" onclick="selectOption(' + i + ')">' +
      '<div class="option-marker">' + letter + '</div>' +
      '<div>' + escapeHtml(opt.text) + '</div>' +
      '</div>';
  });

  const showDeck = ALL_DECKS.length > 1 ? '<span class="badge badge-deck">' + escapeHtml(deckName(card)) + '</span>' : '';

  container.innerHTML = '<div class="card">' +
    '<div class="card-header">' +
      '<span class="badge badge-mc">MC</span>' +
      showDeck +
      '<span class="card-id">Frage ' + card.number + '</span>' +
      boxBadgeHtml(card) +
    '</div>' +
    '<div class="card-body">' +
      '<div class="question-text">' + escapeHtml(card.question) + '</div>' +
      '<div class="options-list" id="optionsList">' + optionsHtml + '</div>' +
      '<div class="action-area">' +
        '<button class="btn btn-primary" id="checkBtn" onclick="checkAnswer()">Antwort pruefen</button>' +
      '</div>' +
      '<div class="explanation" id="explanation">' + escapeHtml(card.explanation || '') + '</div>' +
      '<div class="source" id="source">' + (card.source ? '\u{1F4DA} ' + escapeHtml(card.source) : '') + '</div>' +
      leitnerButtonsHtml() +
    '</div>' +
  '</div>';
}

function selectOption(index) {
  if (mcChecked) return;
  if (selectedOptions.has(index)) selectedOptions.delete(index);
  else selectedOptions.add(index);

  document.querySelectorAll('.option').forEach((el, i) => {
    el.classList.toggle('selected', selectedOptions.has(i));
    const marker = el.querySelector('.option-marker');
    marker.textContent = selectedOptions.has(i) ? '\u2713' : String.fromCharCode(65 + i);
  });
}

function checkAnswer() {
  if (mcChecked) { nextCard(); return; }
  if (selectedOptions.size === 0) return;

  mcChecked = true;
  const card = cards[currentIndex];

  document.querySelectorAll('.option').forEach((el, i) => {
    const isCorrect = card.options[i].correct;
    const isSelected = selectedOptions.has(i);
    el.style.cursor = 'default';

    if (isCorrect) {
      el.classList.add('correct');
      el.querySelector('.option-marker').textContent = '\u2713';
    }
    if (isSelected && !isCorrect) {
      el.classList.add('wrong');
      el.querySelector('.option-marker').textContent = '\u2717';
    }
  });

  document.getElementById('explanation').classList.add('visible');
  if (card.source) document.getElementById('source').classList.add('visible');
  document.getElementById('leitnerBtns').classList.add('visible');
  document.getElementById('checkBtn').style.display = 'none';
}

function renderOffen(card) {
  const container = document.getElementById('cardContainer');

  let answerHtml = '<ul class="answer-list">';
  (card.answer || []).forEach(line => {
    const isIndent = line.startsWith('  ');
    const text = isIndent ? line.trim() : line;
    answerHtml += '<li class="' + (isIndent ? 'indent' : '') + '">' + escapeHtml(text) + '</li>';
  });
  answerHtml += '</ul>';

  const showDeck = ALL_DECKS.length > 1 ? '<span class="badge badge-deck">' + escapeHtml(deckName(card)) + '</span>' : '';

  container.innerHTML = '<div class="card flip-card" onclick="flipCard(event)">' +
    '<div class="card-inner" id="cardInner">' +
      '<div class="card-front">' +
        '<div class="card-header">' +
          '<span class="badge badge-offen">Offen</span>' +
          showDeck +
          '<span class="card-id">Frage ' + card.number + '</span>' +
          boxBadgeHtml(card) +
        '</div>' +
        '<div class="card-body">' +
          '<div class="question-text">' + escapeHtml(card.question) + '</div>' +
          '<div class="flip-hint">Tippen zum Umdrehen</div>' +
        '</div>' +
      '</div>' +
      '<div class="card-back">' +
        '<div class="card-header">' +
          '<span class="badge badge-offen">Antwort</span>' +
          '<span class="card-id">Frage ' + card.number + '</span>' +
        '</div>' +
        '<div class="card-body">' +
          answerHtml +
          '<div class="source visible">' + (card.source ? '\u{1F4DA} ' + escapeHtml(card.source) : '') + '</div>' +
          leitnerButtonsHtml() +
        '</div>' +
      '</div>' +
    '</div>' +
  '</div>';

  requestAnimationFrame(adjustFlipHeight);
}

function flipCard(event) {
  if (event && event.target.closest('.leitner-btn')) return;

  const inner = document.getElementById('cardInner');
  if (!inner) return;
  isFlipped = !isFlipped;
  inner.classList.toggle('flipped', isFlipped);

  if (isFlipped) {
    const btns = document.getElementById('leitnerBtns');
    if (btns) btns.classList.add('visible');
  }

  requestAnimationFrame(adjustFlipHeight);
}

function adjustFlipHeight() {
  const inner = document.getElementById('cardInner');
  if (!inner) return;
  const front = inner.querySelector('.card-front');
  const back = inner.querySelector('.card-back');
  const h = isFlipped ? back.scrollHeight : front.scrollHeight;
  inner.style.height = h + 'px';
}

function renderSessionComplete() {
  const total = sessionStats.correct + sessionStats.wrong;
  document.getElementById('cardContainer').innerHTML = '<div class="card">' +
    '<div class="session-complete">' +
      '<h2>&#10003; Geschafft!</h2>' +
      '<p>' + (total > 0 ? sessionStats.correct + ' von ' + total + ' gewusst' : 'Keine Karten faellig') + '</p>' +
      '<p style="font-size:0.85rem;color:#94a3b8;">Morgen gibt es neue Wiederholungen</p>' +
      '<button class="btn btn-primary" onclick="setMode(\'browse\')">Alle durchblaettern</button>' +
    '</div>' +
  '</div>';
  document.getElementById('progressFill').style.width = '100%';
  document.getElementById('progressText').textContent = 'Fertig!';
  updateStats();
}

// ── Keyboard ──
document.addEventListener('keydown', e => {
  if (document.getElementById('app').style.display === 'none') return;
  if (e.key === 'ArrowLeft') navigate(-1);
  else if (e.key === 'ArrowRight') navigate(1);
  else if (e.key === ' ') {
    e.preventDefault();
    const card = cards[currentIndex];
    if (!card) return;
    if (card.type === 'mc') checkAnswer();
    else flipCard(e);
  }
});

window.addEventListener('resize', adjustFlipHeight);

// ── Init ──
if (localStorage.getItem('lk_auth') === 'yes') {
  loadAndStart();
} else {
  document.getElementById('loginScreen').style.display = 'flex';
}

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>